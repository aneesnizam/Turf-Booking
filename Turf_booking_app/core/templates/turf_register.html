{% extends 'core_base/base.html' %} {% load static %} {% block content %} 
{% if messages %}
<div class="flex justify-center px-6 pt-1">
  <div class="w-full">
    {% for message in messages %}
    <div
      class="{% if message.tags == 'success' %}bg-green-100 border-l-4 border-green-500 text-green-800{% elif message.tags == 'error' %}bg-red-100 border-l-4 border-red-500 text-red-800{% elif message.tags == 'info' %}bg-blue-100 border-l-4 border-blue-500 text-blue-800{% else %}bg-gray-100 border-l-4 border-gray-500 text-gray-800{% endif %} p-4 rounded shadow"
    >
      {{ message }}
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}
<div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
  <!-- Verification Status Alerts -->
  {% if request.user.turfs.exists %} {% for turf in request.user.turfs.all %} 
  {% if turf.verification_status == 'pending' %}
  <div class="mb-8 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <i class="fas fa-hourglass-half text-yellow-400 text-xl"></i>
      </div>
      <div class="ml-3">
        <h3 class="text-lg font-medium text-yellow-800 animate-pulse">
          Pending Verification
        </h3>
        <div class="mt-2 text-sm text-yellow-700">
          <p>Your turf "{{ turf.turf_name }}" is under review.</p>
        </div>
      </div>
    </div>
  </div>
  {% elif turf.verification_status == 'declined' %}
  <div class="mb-8 p-4 bg-red-50 border-l-4 border-red-400 rounded">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <i class="fas fa-times-circle text-red-400 text-xl"></i>
      </div>
      <div class="ml-3">
        <h3 class="text-lg font-medium text-red-800">Verification Declined</h3>
        <div class="mt-2 text-sm text-red-700">
          <p>
            Your turf "{{ turf.turf_name }}" was declined. Please review and
            resubmit.
          </p>
          {% if turf.verification_message %}
          <p class="mt-1 font-medium">
            Admin Note: {{ turf.verification_message }}
          </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %} {% endfor %} {% endif %}

  <!-- Turf Registration Form -->
  <div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="px-4 py-5 sm:p-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Register a New Turf</h2>

      <form
        method="post"
        enctype="multipart/form-data"
        class="space-y-6"
        id="turfForm"
      >
        {% csrf_token %}

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <!-- Turf Name -->
          <div>
            <label
              for="turf_name"
              class="block text-sm font-medium text-gray-700"
              >Turf Name *</label
            >
            <input
              type="text"
              name="turf_name"
              id="turf_name"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <!-- Address -->
          <div class="sm:col-span-2">
            <label for="address" class="block text-sm font-medium text-gray-700"
              >Address *</label
            >
            <textarea
              name="address"
              id="address"
              rows="3"
              required
              placeholder="e.g., Building Name, Street Name, Landmark"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            ></textarea>
          </div>

          <div class="relative mb-4" id="place-field">
            <label for="location-search" class="mb-[3px] font-[600]"
              >Location</label
            >
            <div class="flex gap-2 items-start">
              <!-- Changed from items-stretch to items-center -->
              <input
                type="text"
                id="location-search"
                name="location"
                placeholder="Type your city or hometown"
                class="input_fields flex-grow h-10 px-3 py-2 border rounded-lg"
                autocomplete="off"
                required
              />
              <button
                type="button"
                id="fetch-location"
                class="px-4 h-10 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition duration-200 ease-in-out flex items-center"
              >
                Get
              </button>
            </div>
            <ul
              id="autocomplete-results"
              class="absolute bg-white border rounded shadow mt-1 w-full max-h-[200px] overflow-auto z-50 hidden"
            ></ul>
          </div>
          <div class="sm:col-span-2 hidden" id="auto-message">
            <p
              class="text-sm text-yellow-800 bg-yellow-50 p-3 rounded-lg flex items-center gap-x-3"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 flex-shrink-0"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
              <span
                >The address is auto-filled. Please review all fields,
                especially the <strong>District</strong>, to ensure they are
                correct.</span
              >
            </p>
          </div>

          <!-- hidden -->

          <input type="hidden" name="latitude" id="latitude" />
          <input type="hidden" name="longitude" id="longitude" />

          <!-- Place/Locality -->
          <div>
            <label for="place" class="block text-sm font-medium text-gray-700"
              >Place / Locality *</label
            >
            <input
              type="text"
              name="place"
              id="place"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <!-- City -->
          <div>
            <label for="city" class="block text-sm font-medium text-gray-700"
              >City *</label
            >
            <input
              type="text"
              name="city"
              id="city"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <div>
            <label
              for="district"
              class="block text-sm font-medium text-gray-700"
              >District *</label
            >
            <input
              type="text"
              name="district"
              id="district"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>
          <!-- District Dropdown -->
          <!-- <div>
            <label for="district" class="block text-sm font-medium text-gray-700">District *</label>
            <select name="district" id="district" required
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500">
              <option value="">Select District</option>
              <option value="Thiruvananthapuram">Thiruvananthapuram</option>
              <option value="Kollam">Kollam</option>
              <option value="Pathanamthitta">Pathanamthitta</option>
              <option value="Alappuzha">Alappuzha</option>
              <option value="Kottayam">Kottayam</option>
              <option value="Idukki">Idukki</option>
              <option value="Ernakulam">Ernakulam</option>
              <option value="Thrissur">Thrissur</option>
              <option value="Palakkad">Palakkad</option>
              <option value="Malappuram">Malappuram</option>
              <option value="Kozhikode">Kozhikode</option>
              <option value="Wayanad">Wayanad</option>
              <option value="Kannur">Kannur</option>
              <option value="Kasaragod">Kasaragod</option>
            </select>
          </div> -->

          <!-- Pincode -->
          <div>
            <label for="pincode" class="block text-sm font-medium text-gray-700"
              >Pincode *</label
            >
            <input
              type="text"
              name="pincode"
              id="pincode"
              required
              maxlength="6"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <!-- Opening Time -->
          <div>
            <label
              for="opening_time"
              class="block text-sm font-medium text-gray-700"
              >Opening Time *</label
            >
            <input
              type="time"
              name="opening_time"
              id="opening_time"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <!-- Closing Time -->
          <div>
            <label
              for="closing_time"
              class="block text-sm font-medium text-gray-700"
              >Closing Time *</label
            >
            <input
              type="time"
              name="closing_time"
              id="closing_time"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <!-- Contact Number -->
          <div>
            <label
              for="contact_number"
              class="block text-sm font-medium text-gray-700"
              >Contact Number *</label
            >
            <input
              type="tel"
              name="contact_number"
              id="contact_number"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <!-- Cost Per Hour -->
          <div>
            <label
              for="cost_per_hour"
              class="block text-sm font-medium text-gray-700"
              >Cost Per Hour (â‚¹) *</label
            >
            <input
              type="number"
              name="cost_per_hour"
              id="cost_per_hour"
              min="0"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <div class="mb-4 sm:col-span-2">
            <label class="block mb-2 text-sm font-medium"
              >Select Sports *</label
            >
            <div class="flex flex-wrap gap-2 w-full">
              {% for sport in all_sports %}
              <div class="flex-1 min-w-[120px]">
                <input
                  type="checkbox"
                  id="sport_{{ sport.id }}"
                  name="sports"
                  value="{{ sport.id }}"
                  class="hidden peer"
                />
                <label
                  for="sport_{{ sport.id }}"
                  class="inline-flex items-center justify-between w-full p-3 text-gray-700 bg-white border border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-600 hover:bg-gray-50"
                >
                  <div class="w-full text-center">
                   
                    <div class="text-sm font-medium">{{ sport.name }}</div>
                  </div>
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Image Upload -->
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-gray-700"
              >Turf Images * (Max 3)</label
            >
            <div
              class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md"
            >
              <div class="space-y-1 text-center w-full">
                <div class="flex text-sm text-gray-600 justify-center">
                  <label
                    for="images"
                    class="relative cursor-pointer bg-white rounded-md font-medium text-green-600 hover:text-green-500 focus-within:outline-none"
                  >
                    <span>Click to upload</span>
                    <input
                      id="images"
                      name="images"
                      type="file"
                      multiple
                      accept="image/*"
                      required
                      class="sr-only"
                      onchange="previewImages(this)"
                    />
                  </label>
                </div>
                <p class="text-xs text-gray-500">PNG, JPG up to 5MB each</p>

                <!-- Image preview container inside upload box -->
                <div
                  id="imagePreview"
                  class="mt-3 flex flex-wrap gap-4 justify-center"
                >
                  <!-- Empty preview slots that will be filled when images are selected -->
                  <div
                    class="preview-slot w-24 h-24 bg-gray-100 rounded-md border border-dashed border-gray-300 flex items-center justify-center text-gray-400"
                  >
                    <span class="text-xs">No image</span>
                  </div>
                  <div
                    class="preview-slot w-24 h-24 bg-gray-100 rounded-md border border-dashed border-gray-300 flex items-center justify-center text-gray-400"
                  >
                    <span class="text-xs">No image</span>
                  </div>
                  <div
                    class="preview-slot w-24 h-24 bg-gray-100 rounded-md border border-dashed border-gray-300 flex items-center justify-center text-gray-400"
                  >
                    <span class="text-xs">No image</span>
                  </div>
                </div>
              </div>
            </div>
            <p class="text-[12px] pl-2 text-gray-600">
              <strong>Tip:</strong> Select multiple photos together to preview
              all. Selecting one-by-one will show only the last one, but all
              will be uploaded.
            </p>
          </div>
        </div>

        <div class="flex justify-end">
          <button
            type="submit"
            class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
          >
            Submit for Verification
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById("location-search");
  const fetchButton = document.getElementById("fetch-location");
  const automessage = document.getElementById("auto-message");

  // Listen for clicks on the "Get" button
  fetchButton.addEventListener("click", () => {
    const query = searchInput.value;
    if (!query.trim()) return;

    fetch(`autocomplete-place/?q=${encodeURIComponent(query)}`)
      .then((res) => {
        if (!res.ok) {
          // If the server response is bad (e.g., status 500), handle it as an error
          return res.json().then((err) => {
            throw err;
          });
        }
        return res.json();
      })
      .then((data) => {
        const list = document.getElementById("autocomplete-results");
        list.innerHTML = ""; // Clear old results

        // --- LOGIC CHANGE IS HERE ---
        // First, check if the data received is a valid list (array).
        if (!Array.isArray(data) || data.length === 0) {
          // If it's not a list OR the list is empty, hide the dropdown.
          list.classList.add("hidden");
          // If the data object has an 'error' key, it means the server sent an error message.
          if (data && data.error) {
            console.error("Server returned an error:", data.error);
            // Display the server's error message to the user for better feedback.
            list.innerHTML = `<li class="px-3 py-2 text-red-600">Error: Could not get locations.</li>`;
            list.classList.remove("hidden"); // Show the error
          }
          return; // Stop execution
        }

        // If we reach here, 'data' is a valid list of locations
        data.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item.display_name;
          li.className = "px-3 py-2 cursor-pointer hover:bg-green-100 border-b";

          li.onclick = () => {
            // Populate the form fields (this part is unchanged)
            automessage.classList.remove("hidden");
            document.getElementById("place").value = item.place || "";
            document.getElementById("city").value = item.city || "";
            document.getElementById("district").value = item.district || "";
            document.getElementById("pincode").value = item.pincode || "";

            document.getElementById("latitude").value = item.latitude || "";
            document.getElementById("longitude").value = item.longitude || "";

            searchInput.value = item.display_name;
            list.classList.add("hidden");
          };
          list.appendChild(li);
        });

        list.classList.remove("hidden");
      })
      .catch((error) => {
        // This will catch network errors or errors thrown from the .then() block
        console.error("Error fetching autocomplete:", error);
        const list = document.getElementById("autocomplete-results");
        list.innerHTML = `<li class="px-3 py-2 text-red-600">Request failed. Check network or console.</li>`;
        list.classList.remove("hidden");
      });
  });

  // Hide autocomplete results if user clicks outside (this part is unchanged)
  document.addEventListener("click", function (event) {
    const resultsList = document.getElementById("autocomplete-results");
    const searchField = document.getElementById("place-field");
    if (searchField && !searchField.contains(event.target)) {
      resultsList.classList.add("hidden");
    }
  });

  // Add validation to ensure at least one sport is selected
  document.querySelector("form")?.addEventListener("submit", function (e) {
    const sportsSelected =
      document.querySelectorAll('input[name="sports"]:checked').length > 0;
    const errorElement = document.getElementById("sports-error");

    if (!sportsSelected) {
      errorElement.classList.remove("hidden");
      e.preventDefault();
    } else {
      errorElement.classList.add("hidden");
    }
  });

  let selectedFiles = [];

  function previewImages(input) {
    const previewContainer = document.getElementById("imagePreview");
    previewContainer.innerHTML = ""; // Clear previous previews

    if (input.files && input.files.length > 0) {
      selectedFiles = Array.from(input.files).slice(0, 3); // Max 3 files

      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();

        reader.onload = function (e) {
          const wrapper = document.createElement("div");
          wrapper.className = "relative group w-24 h-24";

          // Image
          const img = document.createElement("img");
          img.src = e.target.result;
          img.className =
            "w-full h-full object-cover rounded-md border border-gray-200";
          img.alt = "Preview";

          // File Name
          const nameTag = document.createElement("p");
          nameTag.className =
            "text-xs text-gray-700 truncate text-center absolute bottom-0 left-0 right-0 bg-white bg-opacity-80 px-1";
          nameTag.textContent =
            file.name.length > 15 ? file.name.slice(0, 12) + "..." : file.name;

          // Remove Button
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className =
            "absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity";
          removeBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>`;
          removeBtn.onclick = () => removeImage(index);

          wrapper.appendChild(img);
          wrapper.appendChild(nameTag);
          wrapper.appendChild(removeBtn);

          previewContainer.appendChild(wrapper);
        };

        reader.readAsDataURL(file); // Read file inside the loop
      });
    } else {
      renderEmptySlots();
    }
  }

  function removeImage(index) {
    selectedFiles.splice(index, 1); // Remove selected file
    previewImages({ files: selectedFiles }); // Re-render previews
  }

  function renderEmptySlots() {
    const previewContainer = document.getElementById("imagePreview");
    previewContainer.innerHTML = "";
    for (let i = 0; i < 3; i++) {
      const emptySlot = document.createElement("div");
      emptySlot.className =
        "w-24 h-24 bg-gray-100 rounded-md border border-dashed border-gray-300 flex items-center justify-center text-gray-400";
      emptySlot.innerHTML = '<span class="text-xs">No image</span>';
      previewContainer.appendChild(emptySlot);
    }
  }
</script>

{% endblock %}
